import time
import telebot
import threading
from flask import Flask, request
import json
import requests


bot = telebot.TeleBot('5117893393:AAETz9iPCIYGpoXpM_Rn4tA8C3FtSNCwyu4')

app = Flask(__name__)


help_message = '- To update subscription filter use /update_filter <filter>'


@app.route('/send_message', methods=['POST'])
def send_message():
    data = request.get_json()
    print(data)
    for tg_id in data["ids"]:
        bot.send_message(tg_id, data["message"], parse_mode="Markdown")
    return "OK"


@bot.message_handler(commands=["start"])
def start(message):
    bot.send_message(message.chat.id, 'Exploit DB Aggregator bot. Use /help for more info')


@bot.message_handler(commands=["help"])
def handle_help(message):
    bot.send_message(message.chat.id, help_message)


@bot.message_handler(commands=["update_filter"])
def handle_add_filter(message):
    requests.post("http://backend:228/parser/update_filter/", data={"telegram_id": message.chat.id, "filter": message.text.replace("/update_filter ", "")})
    bot.send_message(message.chat.id, "Filter updated")


def web():
    app.run(debug=False, use_reloader=False, host='0.0.0.0', port=5000)


def start_bot():
    bot.polling()


if __name__ == '__main__':
    threading.Thread(target=web, daemon=True).start()
    start_bot()