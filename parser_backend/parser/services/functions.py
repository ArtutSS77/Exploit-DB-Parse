import requests
import re

from django.conf import settings
from parser.models import LastCheckedIndex, User


def get_last_index():
    last_number_set = LastCheckedIndex.objects.all()
    if len(last_number_set) == 0:
        return LastCheckedIndex.objects.create(
            number=settings.START_INDEX
        )
    else:
        return last_number_set.first()


def send_message(message):
    requests.post(f"http://{settings.BOT_HOST}:{settings.BOT_PORT}/send_message", json=message)


def check_for_new_exploit():
    last_index = get_last_index()
    url = 'https://www.exploit-db.com/exploits/'+ str(last_index.number)

    response = requests.get(url, headers={'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) '
                                                                      'AppleWebKit/537.36 (KHTML, like Gecko) '
                                                                      'Chrome/98.0.4758.102 Safari/537.36'})
    if response.status_code != 404:
        users = User.objects.all()
        valid_users = {'link': url, 'ids': []}

        for user in users:
            regex = re.compile(user.filters, re.IGNORECASE)

            if regex.search(response.text) is not None:
                valid_users['ids'].append(user.telegram_id)

        send_message(valid_users)

        last_index.number += 1
        last_index.save()
