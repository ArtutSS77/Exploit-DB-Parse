import requests
import re

from django.conf import settings
from parser.models import LastCheckedIndex


def check_last_index():
    last_number_set = LastCheckedIndex.objects.all()
    if len(last_number_set) == 0:
        LastCheckedIndex.objects.create(
            number=settings.START_INDEX
        )
        return settings.START_INDEX
    else:
        return last_number_set.first().number


def check_for_new_exploit():
    url = 'https://www.exploit-db.com/exploits/'
    number = check_last_index()

    response = requests.get(url + str(number), headers={'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) '
                                                                      'AppleWebKit/537.36 (KHTML, like Gecko) '
                                                                      'Chrome/98.0.4758.102 Safari/537.36'})

    regex = re.compile('privilege escalation', re.IGNORECASE)

    if regex.search(response.text) is not None:
        print('Found')
    else:
        print('No match')


def send_message(message):
    requests.post(f"http://{settings.BOT_HOST}:{settings.BOT_PORT}/send_message", json=message)